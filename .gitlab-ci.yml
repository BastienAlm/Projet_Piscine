stages:
  - build
  - test
  - deploy

Build:
  stage: build
  image:
    name: docker:latest
  services:
    - docker:19-dind
  before_script:
    - docker login --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD
  script:
    - docker build -t $DOCKER_REGISTRY/gotham-api .
    - docker tag $DOCKER_REGISTRY/gotham-api $DOCKER_REGISTRY/gotham-api:latest
    - docker push $DOCKER_REGISTRY/gotham-api:latest

Deploy:
  stage: deploy
  image:
    name: docker:latest
  services:
    - docker:19-dind
  before_script:
    - apk add --no-cache curl jq python3 py3-pip
    - pip install ansible
    - echo "$SSH_PRIVATE_KEY" > goth.pem
    - chmod 400 goth.pem
  script:
    - ansible-playbook -i your_inventory.ini -u ec2-user deploy-playbook.yml
